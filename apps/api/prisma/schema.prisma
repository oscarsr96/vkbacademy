generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// NIVEL EDUCATIVO
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model SchoolYear {
  id    String @id @default(cuid())
  name  String @unique // "1eso", "2eso", "3eso", "4eso", "1bach", "2bach"
  label String          // "1Âº ESO", "2Âº ESO", ...

  users   User[]
  courses Course[]
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// USUARIOS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

enum Role {
  STUDENT
  TUTOR
  TEACHER
  ADMIN
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         Role     @default(STUDENT)
  name         String
  avatarUrl    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Nivel educativo (solo relevante para STUDENTs)
  schoolYearId String?
  schoolYear   SchoolYear? @relation(fields: [schoolYearId], references: [id])

  // RelaciÃ³n tutor-alumno (solo relevante para STUDENTs y TUTORs)
  tutorId  String?
  tutor    User?   @relation("TutorStudents", fields: [tutorId], references: [id])
  students User[]  @relation("TutorStudents")

  // GamificaciÃ³n â€” racha y puntos
  currentStreak  Int     @default(0)   // semanas consecutivas con actividad
  longestStreak  Int     @default(0)
  lastActiveWeek String?               // "2026-W07" (ISO week)
  totalPoints    Int     @default(0)   // puntos acumulados (denormalizado para performance)

  // Relaciones
  progress         UserProgress[]
  quizAttempts     QuizAttempt[]
  bookingsAsStudent Booking[]      @relation("StudentBookings")
  teacherProfile   TeacherProfile?
  refreshTokens    RefreshToken[]
  enrollments      Enrollment[]
  userChallenges   UserChallenge[]
  redemptions      Redemption[]
  examAttempts     ExamAttempt[]
  certificates     Certificate[]
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  revoked   Boolean  @default(false)
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CURSOS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Course {
  id          String   @id @default(cuid())
  title       String
  description String?
  coverUrl    String?
  published   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Nivel educativo al que pertenece el curso
  schoolYearId String?
  schoolYear   SchoolYear? @relation(fields: [schoolYearId], references: [id])

  // Asignatura / categorÃ­a temÃ¡tica del curso
  subject String?

  modules       Module[]
  bookings      Booking[]
  enrollments   Enrollment[]
  examQuestions ExamQuestion[] @relation("CourseExamQuestions")
  examAttempts  ExamAttempt[]  @relation("CourseExamAttempts")
  certificates  Certificate[]  @relation("CourseCertificates")
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MATRÃCULAS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Enrollment {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
}

model Module {
  id       String @id @default(cuid())
  title    String
  order    Int
  courseId String

  course        Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons       Lesson[]
  examQuestions ExamQuestion[] @relation("ModuleExamQuestions")
  examAttempts  ExamAttempt[]  @relation("ModuleExamAttempts")
  certificates  Certificate[]  @relation("ModuleCertificates")

  @@index([courseId, order])
}

enum LessonType {
  VIDEO
  QUIZ
  EXERCISE
  MATCH
  SORT
  FILL_BLANK
}

model Lesson {
  id        String     @id @default(cuid())
  title     String
  type      LessonType
  order     Int
  moduleId  String
  youtubeId String?
  content   Json?

  module   Module         @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  quiz     Quiz?
  progress UserProgress[]

  @@index([moduleId, order])
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TESTS / QUIZZES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Quiz {
  id       String @id @default(cuid())
  lessonId String @unique

  lesson    Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions Question[]
  attempts  QuizAttempt[]
}

enum QuestionType {
  SINGLE
  MULTIPLE
  TRUE_FALSE
}

model Question {
  id     String       @id @default(cuid())
  text   String
  type   QuestionType
  quizId String
  order  Int          @default(0)

  quiz    Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers Answer[]

  @@index([quizId, order])
}

model Answer {
  id         String  @id @default(cuid())
  text       String
  /// NUNCA exponer en endpoints pÃºblicos de /quizzes/:id
  isCorrect  Boolean @default(false)
  questionId String

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model QuizAttempt {
  id          String   @id @default(cuid())
  userId      String
  quizId      String
  score       Float    // 0.0 - 100.0
  /// [{questionId, answerId}]
  answers     Json
  completedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([userId, quizId])
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// PROGRESO
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model UserProgress {
  id          String    @id @default(cuid())
  userId      String
  lessonId    String
  completed   Boolean   @default(false)
  completedAt DateTime?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RESERVAS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model TeacherProfile {
  id     String  @id @default(cuid())
  userId String  @unique
  bio    String?

  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  availability AvailabilitySlot[]
  bookings     Booking[]
}

model AvailabilitySlot {
  id          String @id @default(cuid())
  teacherId   String
  dayOfWeek   Int    // 0=Dom, 1=Lun, ..., 6=SÃ¡b
  startTime   String // "09:00"
  endTime     String // "10:00"
  isRecurring Boolean @default(true)

  teacher TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([teacherId, dayOfWeek])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
}

enum BookingMode {
  IN_PERSON
  ONLINE
}

model Booking {
  id        String        @id @default(cuid())
  studentId String
  teacherId String
  startAt   DateTime
  endAt     DateTime
  status    BookingStatus @default(PENDING)
  mode      BookingMode   @default(IN_PERSON)
  notes      String?
  courseId   String?
  /// URL de sala Daily.co â€” solo presente cuando mode=ONLINE y status=CONFIRMED
  meetingUrl String?
  createdAt  DateTime     @default(now())
  updatedAt DateTime      @updatedAt

  student User           @relation("StudentBookings", fields: [studentId], references: [id])
  teacher TeacherProfile @relation(fields: [teacherId], references: [id])
  course  Course?        @relation(fields: [courseId], references: [id])

  @@index([studentId])
  @@index([teacherId])
  @@index([startAt])
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GAMIFICACIÃ“N â€” CANJES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model Redemption {
  id          String    @id @default(cuid())
  userId      String
  itemName    String
  cost        Int
  redeemedAt  DateTime  @default(now())
  delivered   Boolean   @default(false)
  deliveredAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([redeemedAt])
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GAMIFICACIÃ“N â€” RETOS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

enum ChallengeType {
  LESSON_COMPLETED   // completa N lecciones en total
  MODULE_COMPLETED   // completa N mÃ³dulos enteros
  COURSE_COMPLETED   // completa N cursos completos
  QUIZ_SCORE         // consigue â‰¥ N% en cualquier quiz
  BOOKING_ATTENDED   // asiste a N clases confirmadas (endAt < now)
  STREAK_WEEKLY      // racha activa de N semanas consecutivas
  TOTAL_HOURS        // acumula N horas (bookings + lecciones VIDEO Ã— 20min)
}

model Challenge {
  id          String        @id @default(cuid())
  title       String
  description String
  type        ChallengeType
  target      Int           // umbral numÃ©rico (ej: 5, 80, 3)
  points      Int           // puntos al completarse
  badgeIcon   String        @default("ğŸ…")
  badgeColor  String        @default("#6366f1")
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  userChallenges UserChallenge[]
}

model UserChallenge {
  id            String    @id @default(cuid())
  userId        String
  challengeId   String
  progress      Int       @default(0)
  completed     Boolean   @default(false)
  completedAt   DateTime?
  awardedPoints Int       @default(0)

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenge Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([userId, challengeId])
  @@index([userId])
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// FACTURACIÃ“N
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model BillingConfig {
  id                       String   @id @default("default")
  studentMonthlyPrice      Float    @default(15.00)
  classOnlineRatePerHour   Float    @default(15.00)
  classInPersonRatePerHour Float    @default(18.00)
  clubCommissionRate       Float    @default(0.10)
  infrastructureMonthlyCost Float   @default(25.00)
  s3MonthlyCost            Float    @default(2.00)
  anthropicMonthlyCost     Float    @default(5.00)
  updatedAt                DateTime @updatedAt
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CERTIFICADOS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

enum CertificateType {
  MODULE_COMPLETION   // completÃ³ todas las lecciones del mÃ³dulo
  COURSE_COMPLETION   // completÃ³ todas las lecciones del curso
  MODULE_EXAM         // aprobÃ³ el examen del mÃ³dulo (â‰¥ 50%)
  COURSE_EXAM         // aprobÃ³ el examen del curso (â‰¥ 50%)
}

model Certificate {
  id         String          @id @default(cuid())
  userId     String
  courseId   String?         // null si es certificado de mÃ³dulo
  moduleId   String?         // null si es certificado de curso
  type       CertificateType
  verifyCode String          @unique @default(cuid())
  examScore  Float?          // solo para MODULE_EXAM / COURSE_EXAM
  issuedAt   DateTime        @default(now())

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course? @relation("CourseCertificates", fields: [courseId], references: [id])
  module Module? @relation("ModuleCertificates", fields: [moduleId], references: [id])

  @@index([userId])
  @@index([courseId])
  @@index([moduleId])
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EXÃMENES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

model ExamQuestion {
  id       String       @id @default(cuid())
  text     String
  type     QuestionType // reutiliza el enum existente (SINGLE, MULTIPLE, TRUE_FALSE)
  order    Int          @default(0)
  courseId String?      // null si es de mÃ³dulo
  moduleId String?      // null si es de curso

  course  Course?      @relation("CourseExamQuestions", fields: [courseId], references: [id], onDelete: Cascade)
  module  Module?      @relation("ModuleExamQuestions", fields: [moduleId], references: [id], onDelete: Cascade)
  answers ExamAnswer[]

  @@index([courseId])
  @@index([moduleId])
}

model ExamAnswer {
  id         String      @id @default(cuid())
  text       String
  /// NUNCA exponer isCorrect en respuestas del endpoint de inicio de examen
  isCorrect  Boolean     @default(false)
  questionId String

  question ExamQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

model ExamAttempt {
  id                String    @id @default(cuid())
  userId            String
  courseId          String?
  moduleId          String?
  numQuestions      Int
  timeLimit         Int?      // segundos; null = sin lÃ­mite
  onlyOnce          Boolean   @default(false)
  score             Float?    // null hasta submit
  questionsSnapshot Json      // snapshot con isCorrect para correcciÃ³n server-side
  answers           Json      @default("[]") // [{questionId, answerId}]
  startedAt         DateTime  @default(now())
  submittedAt       DateTime?

  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course? @relation("CourseExamAttempts", fields: [courseId], references: [id])
  module Module? @relation("ModuleExamAttempts", fields: [moduleId], references: [id])

  @@index([userId])
  @@index([courseId])
  @@index([moduleId])
}
